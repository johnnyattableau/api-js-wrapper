<!DOCTYPE html>
<html>
<head>
  <title>Advanced Interaction Test</title>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!-- Extensions Library -->
  <script src="http://localhost:7755/extensions-api.js"></script>
</head>
<body>
  <div class="container">
    <div>
      <h3>Advanced Interaction Test</h3>
      <p>This tests some advanced interactions.</p>
      <p>The tests are for advancedInteractionTest.twbx.</p>
      <p>If used in another workbook, some tests may fail.</p>
      <p>Refresh Data should be run after Run Tests. </p>
      <p>Refresh Data forces a reload of the extension if in a story point.</p>
      <p>There should be 3 items selected in each story point, and nothing selected in dashboards.</p>
        <p>Dashboard name - <b><span id="dashboardName">???</span></b></p>
        <button id="start" class="btn btn-primary">Run Tests</button>
        <button id="refresh-data" class="btn btn-primary">Refresh Data</button>
    </div>
    <div style="margin-top:15px;">
      <h4>Final Result = <span id="resultsField">???</span></b>
      </h4>
    </div>
    <div>
      <h4>Status</h4>
      <div id="statusField"></div>
    </div>
</body>
<script>
  var expectedTestCount = 0;
  var failCount = 0;
  var passCount = 0;
  var onDoneCallback = undefined;

  function checkTestCount() {
    if (passCount + failCount === expectedTestCount) {
      $("#statusField").append('Tests complete, Pass = ' + passCount + ' / Fail = ' + failCount);
    }
    if (failCount > 0) {
      $("#resultsField").text('FAIL!');
      onDoneCallback('FAIL');
    }
    else {
      $("#resultsField").text('PASS');
      onDoneCallback('PASS');
    }
  }

  function pass(testCase) {
    $("#statusField").append('<p style="color:green;">' + testCase + ': <strong>pass</strong></p>');
    passCount += 1;
    checkTestCount();
  }

  function fail(testCase) {
    $("#statusField").append('<p style="color:red;">' + testCase + ': <strong>FAIL</strong></p>');
    failCount += 1;
    checkTestCount();
  }

  function assertEqual(testName, lhs, rhs) {
    if (lhs === rhs) {
      return pass(testName);
    }
    return fail(testName);
  }

  function assert(testName, expectedCondition) {
    if (expectedCondition) {
      return pass(testName);
    }
    return fail(testName);
  }

  function summaryDataTest() {
    var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
    worksheet.getSummaryDataAsync().then(function (dataTable) {
      assert('summaryDataTest', dataTable.columns.length = 2);
    },
      function (err) {
        fail('summaryDataTest: ' + err);
      });
  }

  function selectionMarksTest() {
    var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
    worksheet.getSelectedMarksAsync().then(function (marksCollection) {
// This doesn't work, see TFSID 968496
// if (tableau.extensions.dashboardContent.dashboard.sheetType === tableau.SheetType.TYPE_STORY) {
// ...Meanwhile, dig into the implementation
      if(typeof tableau.extensions.dashboardContent.dashboard._dashboardImpl._sheetPath.storyboard !== 'undefined') {
        assertEqual('selectionMarksTest', marksCollection.data[0].data.length, 3);
      } else {
        assertEqual('selectionMarksTest', marksCollection.data[0].data.length, 0);
      }
    },
      function (err) {
        fail('selectionMarksTest: ' + err);
      });
  }

  function filterTest() {
    var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
    worksheet.getFiltersAsync().then(function (filters) {
      assert('filterTest', filters.length >= 2);
    },
      function (err) {
        fail('filterTest' + err);
      });
  }

  function dataSourcesTest() {
    var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
    worksheet.getDataSourcesAsync().then(function (datasources) {
      assert('dataSourcesTest', datasources.length >= 1);
    },
      function (err) {
        fail('getDataSourcesAsync: ' + err);
      });
  }

  function refreshTest() {
    var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
    worksheet.getDataSourcesAsync().then(function (datasources) {
      datasources[0].refreshAsync().then(function () {
        pass('refreshTest')
      }, function (err) {
        fail('refreshAsync: ' + err);
      });
    }, function (err) {
      fail('getDataSourcesAsync: ' + err);
    });
  }

  function runTests() {
    var testCases = [summaryDataTest,
      selectionMarksTest,
      filterTest,
      dataSourcesTest];

    // + 1 for the initializeAsync test
    expectedTestCount = testCases.length + 1;

    testCases.forEach(function (testFn) {
      testFn();
    });
  }

  function runExtensionTests(callback) {
    onDoneCallback = callback;
    tableau.extensions.initializeAsync().then(function () {
      $('#dashboardName').text(tableau.extensions.dashboardContent.dashboard.name);
      pass('initialize');
      runTests();
    }, function (err) {
      fail('initialize' + err);
      onDoneCallback('InitializeAsync failed! ... FAIL');
    });
  }

  window.runExtensionTests = runExtensionTests;

  function postResults(message) {
    $('#resultField').text(message);
  }

  $(function () {
    if (performance.navigation.type == 1) {
      alert('hey there!');
    }
  });

  $("#start").click(function () {
    runExtensionTests(postResults);
  })

  $("#refresh-data").click(function () {
    refreshTest();
  })
</script>
</html>
