<!DOCTYPE html>
<html>
  <head>
    <title>Example Extensions</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" >
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" ></script>

    <!-- Extensions Library (this will be hosted on a CDN eventually) -->
    <script src="http://localhost:7755/extensions-api.js"></script>
  </head>
  <body>
    <div class="container">
      <div>
        <h1>Automatic Tests</h1>
        <button id="start" class="btn btn-primary">Run</button>
      </div>
      <div>
        <h4>Results</h4>
        <div id="results"></div>
      </div>
  </body>
  <script>
    function log(message) {
      $("#results").append('<p style="color:green;">' + message + '</p>');
    }

    function pass(testCase) {
      $("#results").append('<p style="color:green;">' + testCase + ': <strong>pass</strong></p>');
    }

    function fail(testCase) {
      $("#results").append('<p style="color:red;">' + testCase + ': <strong>FAIL</strong></p>');
    }

    function assertEqual(testName, actual, expected) {
      if (actual === expected) {
        return pass(testName);
      }
      return fail(testName + ' (actual/expected: ' + actual + '/' + expected + ')');
    }


    var filterNotificationSent = false;

    function filterChangedTest() {
      setTimeout(function() {
        assertEqual('filterChangedTest', filterNotificationSent, true);
      }, 3000);
    }

    function applyFilterTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.addEventListener(tableau.TableauEventType.FilterChanged, (event) => {
        filterNotificationSent = true;
      });
      var filterField = "State";
      worksheet.applyFilterAsync(filterField, ['California'], tableau.FilterUpdateType.Remove, {}).then(function (result) {
        assertEqual('applyFilterTest', result, filterField);
      },
      function(err) {
        fail('applyFilterTest: ' + err);
      });
/**

        worksheet.applyFilterAsync
        fieldName: string, values: Array<string>, updateType: FilterUpdateType, filterOptions: FilterOptions
      },
*/
    }

    function summaryDataTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getSummaryDataAsync().then(function (dataTable) {
        assertEqual('summaryDataTest', dataTable.totalRowCount, 20);
      },
      function(err) {
        fail('summaryDataTest: ' + err);
      });
    }

    function summaryDataTypeTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getSummaryDataAsync().then(function (dataTable) {
        // The second element in each data item should be the sales value
        var salesValueType = typeof dataTable.data[0][1].value;
        log('With v1.2, the sales value should always be a number (actual : ' + salesValueType + ')');
        assertEqual('summaryDataTypeTest', salesValueType, 'number');
        assertEqual('SummaryDataTypeTest value', dataTable.data[0][1].value, 33069)
      },
      function(err) {
        fail('summaryDataTypeTest: ' + err);
      });
    }

    function selectionMarksTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getSelectedMarksAsync().then(function(marksCollection) {
        assertEqual('selectionMarksTest', marksCollection.data.length, 1);
      },
      function(err) {
        fail('selectionMarksTest: ' + err);
      });
    }

    function filterTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getFiltersAsync().then(function(filters) {
        assertEqual('filterTest (length)', filters.length, 2);
        assertEqual('filterTest (1st type)', filters[0].filterType, 'categorical');
        assertEqual('filterTest (2nd type)', filters[1].filterType, 'range');
      },
      function(err) {
        fail('filterTest' + err);
      });
    }

    function dataSourcesTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getDataSourcesAsync().then(function(datasources) {
        assertEqual('dataSourcesTest', datasources[0].isExtract, true);
      },
      function(err) {
        fail('getDataSourcesAsync: ' + err);
      });
    }

    function underlyingDataTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getUnderlyingDataAsync().then(function(success) {
        assertEqual('underlyingDataTest', success.totalRowCount, 3960);
      }, function(err) {
        fail(err);
      });
    }

    function versionTest() {
      var version = tableau.extensions.environment.apiVersion;
      log('Starting with v1.2, the version should be reported correctly (actual:' + version + ')');
      assertEqual('versionTest', version, '1.3.0');
    }

   function refreshTest() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      worksheet.getDataSourcesAsync().then(function(datasources) {
        datasources[0].refreshAsync().then(function() {
          pass('refreshTest')
        }, function(err) {
        fail('refreshAsync: ' + err);
        });
      }, function(err) {
        fail('getDataSourcesAsync: ' + err);
      });
    }

    function zoneTypeTest() {
      var extensionZoneName = 'NOT FOUND';
      var extensionCount = 0;
      var zones = tableau.extensions.dashboardContent.dashboard.objects;
      zones.forEach(zone => {
        if (zone.type === tableau.DashboardObjectType.Extension) {
          extensionCount += 1;
          extensionZoneName = zone.name;
        }
      });
      log('Starting with v2019.4, we should be able to find our extension zone name: (actual:' + extensionZoneName + ')');
      assertEqual('zoneTypeTest - name', extensionZoneName, 'Automatic Tests');
      assertEqual('zoneTypeTest - count', extensionCount, 1);
    }

    function runTests() {
      var testCases = [
        summaryDataTest,
        summaryDataTypeTest,
        filterTest,
        applyFilterTest,
        underlyingDataTest,
        versionTest,
        selectionMarksTest,
        dataSourcesTest,
        refreshTest,
        filterChangedTest,
        zoneTypeTest
      ];

      testCases.forEach(function(testFn) {
        testFn();
      });
    }

    function resetFilter() {
      var worksheet = tableau.extensions.dashboardContent.dashboard.worksheets[0];
      var filterField = "State";
      worksheet.applyFilterAsync(filterField, ['California'], tableau.FilterUpdateType.Add, {}).then(function (result) {
        assertEqual('applyFilterTest', result, filterField);
      },
      function(err) {
        fail('applyFilterTest: ' + err);
      });
    }

    function initialize() {
      tableau.extensions.initializeAsync().then(function() {
        pass('initialize');
        runTests();
        resetFilter();
      }, function(err) {
        fail('initialize' + err);
        $("#tally").append('InitializeAsync failed! ... aborting test run' + '<br/>').css('color', 'Red');
      });
    }

    $("#start").click(function() {
      initialize();
    })
  </script>
</html>
